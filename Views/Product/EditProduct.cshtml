@model WebApplication1.Models.ViewModels.ProductViewModel

@{
    ViewData["Title"] = "Edit Product";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-warning text-white">
                    <h4 class="mb-0">Edit Product</h4>
                </div>
                <div class="card-body">
                    <form asp-action="EditProduct" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="ProductId" />

                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="ProductName" class="control-label">Product Name</label>
                                    <input asp-for="ProductName" class="form-control" />
                                    <span asp-validation-for="ProductName" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="CategoryId" class="control-label">Category</label>
                                    <select asp-for="CategoryId" class="form-control" asp-items="ViewBag.Categories"></select>
                                    <span asp-validation-for="CategoryId" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="SupplierId" class="control-label">Supplier</label>
                                    <select asp-for="SupplierId" class="form-control" asp-items="ViewBag.Suppliers"></select>
                                    <span asp-validation-for="SupplierId" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="BasePrice" class="control-label">Price</label>
                                    <input asp-for="BasePrice" class="form-control" type="number" step="0.01" />
                                    <span asp-validation-for="BasePrice" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="DiscountPercent" class="control-label">Discount (%)</label>
                                    <input asp-for="DiscountPercent" class="form-control" type="number" step="0.01" />
                                    <span asp-validation-for="DiscountPercent" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Status" class="control-label">Status</label>
                                    <select asp-for="Status" class="form-control">
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                    <span asp-validation-for="Status" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label asp-for="Description" class="control-label">Description</label>
                            <textarea asp-for="Description" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <div class="form-check">
                                <input asp-for="Featured" class="form-check-input" type="checkbox" />
                                <label asp-for="Featured" class="form-check-label">Featured</label>
                            </div>
                        </div>

                        <hr />

                        <!-- Product Images Management -->
                        <h4>Manage Product Images</h4>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Image</th>
                                        <th>Primary</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var image in Model.ProductImages)
                                    {
                                        <tr>
                                            <td><img src="@image.ImageUrl" width="100" alt="Product Image" /></td>
                                            <td>@((image.IsPrimary ?? true) ? "Yes" : "No")</td>
                                            <td>
                                                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editImageModal-@image.ImageId">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <a asp-action="DeleteImage" asp-route-id="@image.ImageId" class="btn btn-danger btn-sm"
                                                   onclick="return confirm('Are you sure you want to delete this image?');">
                                                    <i class="fas fa-trash"></i> Delete
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addImageModal">
                            <i class="fas fa-plus"></i> Add Image
                        </button>

                        <hr />

                        <!-- Product Variants Management -->
                        <h4>Manage Product Variants</h4>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>Size</th>
                                        <th>Color</th>
                                        <th>Material</th>
                                        <th>SKU</th>
                                        <th>Stock</th>
                                        <th>Image</th>
                                        <th>Price</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var variant in Model.ProductVariants)
                                    {
                                        <tr>
                                            <td>@variant.Size.SizeName</td>
                                            <td>@variant.Color.ColorName</td>
                                            <td>@variant.Material?.MaterialName</td>
                                            <td>@variant.Sku</td>
                                            <td>@variant.Stock</td>
                                            <td>@(variant.Image ?? "")</td>
                                            <td>@(variant.AdditionalPrice?.ToString("C") ?? "N/A")</td>
                                            <td>
                                                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editVariantModal-@variant.VariantId">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <a asp-action="DeleteVariant" asp-route-id="@variant.VariantId" class="btn btn-danger btn-sm"
                                                   onclick="return confirm('Are you sure you want to delete this variant?');">
                                                    <i class="fas fa-trash"></i> Delete
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addVariantModal">
                            <i class="fas fa-plus"></i> Add Variant
                        </button>

                        <hr />

                        <div class="form-group mt-4 d-flex justify-content-between">
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to List
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </div>
                    </form>


                    <!-- Product Image Add Modal -->
                    <div class="modal fade" id="addImageModal" tabindex="-1" aria-labelledby="addImageModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Add New Image</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form asp-action="AddImage" method="post" enctype="multipart/form-data">
                                        <input type="hidden" name="ProductId" value="@Model.ProductId" />

                                        <div class="mb-3">
                                            <label class="form-label">Upload Image</label>
                                            <input type="file" name="ImageFile" class="form-control" required />
                                        </div>

                                        <div class="mb-3 form-check">
                                            <input type="checkbox" name="IsPrimary" value="true" class="form-check-input" />
                                            <label class="form-check-label">Set as Primary</label>
                                        </div>

                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="submit" class="btn btn-success">Add Image</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Image Edit Modal -->
                    @foreach (var image in Model.ProductImages)
                    {
                        <div class="modal fade" id="editImageModal-@image.ImageId" tabindex="-1" aria-labelledby="editImageModalLabel-@image.ImageId" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Edit Image</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form asp-action="EditImage" method="post">
                                            <input type="hidden" name="ImageId" value="@image.ImageId" />
                                            <input type="hidden" name="ProductId" value="@Model.ProductId" />

                                            <div class="mb-3">
                                                <label class="form-label">Image URL</label>
                                                <input type="text" name="ImageUrl" class="form-control" value="@image.ImageUrl" required />
                                            </div>

                                            <div class="mb-3 form-check">
                                                <input type="checkbox" name="IsPrimary" class="form-check-input" value="true" @(image.IsPrimary == true ? "checked" : "") />
                                                <label class="form-check-label">Set as Primary</label>
                                            </div>

                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }



                    <!-- Product Variant Add Modal -->
                    <div class="modal fade" id="addVariantModal" tabindex="-1" aria-labelledby="addVariantModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Add New Variant</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form asp-action="AddVariant" method="post">
                                        <input type="hidden" name="ProductId" value="@Model.ProductId" />

                                        <div class="mb-3">
                                            <label class="form-label">Color</label>
                                            <select name="ColorId" class="form-control" asp-items="ViewBag.Colors" required></select>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Size</label>
                                            <select name="SizeId" class="form-control" asp-items="ViewBag.Sizes" required></select>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Material</label>
                                            <select name="MaterialId" class="form-control" asp-items="ViewBag.Materials">
                                                <option value="">None</option>
                                            </select>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">SKU</label>
                                            <input type="text" name="Sku" class="form-control" required />
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Stock</label>
                                            <input type="number" name="Stock" class="form-control" min="0" required />
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Image URL</label>
                                            <input type="text" name="Image" class="form-control" />
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Additional Price</label>
                                            <input type="number" name="AdditionalPrice" class="form-control" step="0.01" min="0" />
                                        </div>

                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="submit" class="btn btn-success">Add Variant</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Variant Edit Modal -->
                    @foreach (var variant in Model.ProductVariants)
                    {
                        <div class="modal fade" id="editVariantModal-@variant.VariantId" tabindex="-1" aria-labelledby="editVariantModalLabel-@variant.VariantId" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Edit Variant</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form asp-action="EditVariant" method="post">
                                            <input type="hidden" name="VariantId" value="@variant.VariantId" />
                                            <input type="hidden" name="ProductId" value="@Model.ProductId" />

                                            <div class="mb-3">
                                                <label class="form-label">Color</label>
                                                <select name="ColorId" class="form-control" asp-items="ViewBag.Colors">
                                                    <option selected value="@variant.ColorId">@variant.Color.ColorName</option>
                                                </select>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Size</label>
                                                <select name="SizeId" class="form-control" asp-items="ViewBag.Sizes">
                                                    <option selected value="@variant.SizeId">@variant.Size.SizeName</option>
                                                </select>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Material</label>
                                                <select name="MaterialId" class="form-control" asp-items="ViewBag.Materials">
                                                    <option value="">None</option>
                                                    @if (variant.MaterialId.HasValue)
                                                    {
                                                        <option selected value="@variant.MaterialId">@variant.Material?.MaterialName</option>
                                                    }
                                                </select>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">SKU</label>
                                                <input type="text" name="Sku" class="form-control" value="@variant.Sku" required />
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Stock</label>
                                                <input type="number" name="Stock" class="form-control" value="@variant.Stock" min="0" required />
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Image URL</label>
                                                <input type="text" name="Image" class="form-control" value="@variant.Image" />
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Additional Price</label>
                                                <input type="number" name="AdditionalPrice" class="form-control" step="0.01" min="0" value="@variant.AdditionalPrice" />
                                            </div>

                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
}
